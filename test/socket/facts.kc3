require Facts
require File
require Socket
require Socket.Buf
require Socket.Facts

(r = fork()) ; void
if (r < 0) do
  exit(1)
end
if r == 0 do
  # Server: receive facts and send back
  server_facts = Facts.database()
  File.unlink("server_test.facts")
  Facts.open(server_facts, "server_test.facts")
  puts("server: listening on 15002")
  if ! Socket.Facts.listen(server_facts, "localhost", "15002") do
    puts("server: listen failed")
    exit_subprocess(1)
  end
  puts("server: accepted connection, waiting for facts")
  sleep(2)
  Facts.with_tags(server_facts, ?, ?, ?, fn (fact) {
    puts("server: received #{inspect(fact)}")
  })
  puts("server: adding server fact")
  Facts.add_tags(server_facts, :server, :says, :hello)
  sleep(1)
  puts("server: OK")
  exit_subprocess(0)
else
  sleep(1)
  # Client: send facts
  client_facts = Facts.database()
  File.unlink("facts_test.facts")
  Facts.open(client_facts, "facts_test.facts")
  puts("client: connecting to 15002")
  if ! Socket.Facts.open(client_facts, "localhost", "15002") do
    puts("client: open failed")
    exit(1)
  end
  puts("client: adding fact")
  Facts.add_tags(client_facts, :a, :b, :c)
  sleep(4)
  puts("client: checking for server facts")
  Facts.with_tags(client_facts, ?, ?, ?, fn (fact) {
    puts("client: has #{inspect(fact)}")
  })
  Socket.Facts.close(client_facts)
  puts("client: OK")
end
0
